name: Pull Docker Image And Upload Artifact

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image with tag (e.g. nginx:1.25)'
        required: true
      platform:
        description: 'Target platform'
        required: true
        default: 'linux/amd64'
        type: choice
        options:
          - linux/amd64
          - linux/arm64

jobs:
  pull-and-pack:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull and Save Image
        run: |
          echo "Pulling ${{ inputs.image }} for ${{ inputs.platform }}"
          docker pull --platform=${{ inputs.platform }} "${{ inputs.image }}"

          # 将镜像名和平台名安全化，用于文件名
          SAFE_IMAGE=$(echo "${{ inputs.image }}" | tr '/:' '_')
          SAFE_PLATFORM=$(echo "${{ inputs.platform }}" | tr '/' '_')
          TAR_NAME="${SAFE_IMAGE}_${SAFE_PLATFORM}.tar.gz"

          docker save "${{ inputs.image }}" | gzip > "$TAR_NAME"

          # 设置环境变量供上传使用
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: ${{ env.TAR_NAME }}
